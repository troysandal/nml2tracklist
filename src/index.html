<!DOCTYPE html>
<html>

<head>
    <title>Convert NML To Tracklist</title>
    <link rel="manifest" href="/manifest.json">
    <meta charset="utf-8">
    <style>
        textarea {
            width: 800px;
            height: 300px;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script>
        function nmlToTracks(xmlDoc) {
            return $(xmlDoc)
                .find("ENTRY")
                .map((index, entry) => {
                    return { title: entry.getAttribute('TITLE'), artist: entry.getAttribute('ARTIST') }
                })
                .filter((index, track) => !!track.title).toArray()
        }

        function formatTrackList(trackList) {
            const padding = trackList.length.toString().length
            const formatTrack = (track, index) => {
                return `${(index + 1)}. ${track.title} - ${track.artist}`
            }

            return trackList
                .map(formatTrack)
                .join('\n')
        }
        function convert() {
            const nml = document.getElementById('nml').value

            var parser = new DOMParser();
            var xmlDoc = parser.parseFromString(nml, "text/xml");
            var parseerror = $(xmlDoc).find("parsererror");

            if (parseerror.length !== 0) {
                document.getElementById('trackList').value = 'Bad NML File'
                return
            }

            const tracks = nmlToTracks(xmlDoc)
            document.getElementById('trackList').value = formatTrackList(tracks)
        }

        function upload(e) {
            const file = e.target.files[0]
            if (!file) {return}
            const reader = new FileReader();

            reader.readAsText(file);
            reader.onload = function () {
                $('#nml').val(reader.result.toString())
                convert()
            }
            e.target.value = ''
        }

        /** 
         * Doesn't work - haven't debugged.
         */
        function copyToClipboard() {
            const copyText = document.getElementById("trackList")
            copyText.select()
            copyText.setSelectionRange(0, 99999) /* For mobile devices */
            navigator.permissions.query({ name: "clipboard-write" }).then(result => {
                if (result.state == "granted" || result.state == "prompt") {
                    navigator.clipboard.writeText(copyText.value)
                    console.log(copyText.value)
                    alert("Track list copied to Clipbaord")
                } else {
                    alert('Sorry, no clipboard access.')
                }
            });
        }
    </script>
</head>

<body>
    <h2>NML</h2>
    <p>Paste in your NML file below or press Import to upload it.</p>
    <p><input type="file" accept=".nml" id="nmlFile"></p>
    <textarea id="nml"></textarea>
    <h2>Your Tracklist</h2>
    <!-- <p><button onclick="copyToClipboard()">Copy To Clipboard</button></p> -->
    <textarea id="trackList"></textarea>
    <script>
        document.getElementById('nmlFile').addEventListener("change", upload, false)
        document.getElementById('nml').addEventListener("input", convert, false)
    </script>
</body>

</html>